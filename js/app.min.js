function removeElement(e){e.parentNode.removeChild(e)}var x2js=new X2JS,app=app||{};app.file=null;app.nodes=null;app.config={width:960,height:2200,diameter:1e3,noderadius:5,layout:"radial"};app.layouts={};app.init=function(){var e=new XMLHttpRequest;if(window.File&&window.FileList&&window.FileReader&&e.upload){var t=document.getElementById("canvas");t.addEventListener("dragover",app.fileDragHover,!1);t.addEventListener("dragleave",app.fileDragHover,!1);t.addEventListener("drop",app.fileSelectHandler,!1);t.style.display="block"}else app.sorry();app.bindConfigUI()};app.sorry=function(){alert("Sorry, Noder needs a state of the art browser.")};app.bindConfigUI=function(){document.getElementById("layout-vertical").style.display="none";var e=document.getElementById("cfg-layout");e.onchange=function(e){app.config.layout=this.value;console.log("New layout ",this.value);switch(this.value){case"radial":document.getElementById("layout-vertical").style.display="none";document.getElementById("layout-radial").style.display="";break;case"vertical":document.getElementById("layout-vertical").style.display="";document.getElementById("layout-radial").style.display="none"}app.renderData()};var t=["width","height","diameter","noderadius"];t.forEach(function(e){var t=document.getElementById("cfg-"+e);t.value=app.config[e];t.onchange=function(){app.config[e]=this.value;console.log("New ",e,": ",this.value);app.renderData()}})};app.fileDragHover=function(e){e.stopPropagation();e.preventDefault();e.target.className=e.type=="dragover"?"hover":""};app.fileSelectHandler=function(e){app.fileDragHover(e);var t=e.target.files||e.dataTransfer.files;for(var n=0,r;r=t[n];n++)app.parseFile(r)};app.parseFile=function(e){if(e.name.substr(e.name.lastIndexOf("."))===".mm"){console.log("Detected Freenode .mm file");console.log(e);var t=new FileReader;t.onload=function(e){console.log("File loaded",e);app.file=e.target.result;window.setTimeout(app.prepareData,500)};t.readAsText(e)}else alert("Sorry, currently we're only accepting Freenode .mm files")};app.prepareData=function(){console.log("Preparing data");var e=x2js.xml_str2json(app.file);console.log(e);app.nodes=app.convertFreemindNodes(e);app.renderData()};app.renderData=function(){console.log("Rendering data");var e=document.getElementById("rendering");e&&removeElement(e);var t=app.config.layout;app.layouts[t]&&app.layouts[t]();var n=document.getElementById("canvas").innerHTML,r=btoa(unescape(encodeURIComponent(n))),i=document.getElementById("download-svg");i.href="data:image/svg+xml;base64,\n"+r};app.layouts.radial=function(){var e=app.config.diameter,t=app.config.noderadius,n=d3.layout.tree().size([360,e/2-200]).separation(function(e,t){return(e.parent==t.parent?1:2)/e.depth}),r=d3.svg.diagonal.radial().projection(function(e){return[e.y,e.x/180*Math.PI]}),i=d3.select("#canvas").append("svg").attr("id","rendering").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").attr("version","1.1").attr("width",e).attr("height",e-150).append("g").attr("transform","translate("+e/2+","+e/2+")"),s=n.nodes(app.nodes),o=n.links(s),u=i.selectAll(".link").data(o).enter().append("path").attr("class","link").attr("d",r).attr("fill","none").attr("stroke","#ccc").attr("stroke-width","1.5px"),a=i.selectAll(".node").data(s).enter().append("g").attr("class","node").attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+e.y+")"});a.append("circle").attr("r",t).attr("fill","#fff").attr("stroke","steelblue").attr("stroke-width","1.5px");a.append("text").attr("dy",".31em").attr("text-anchor",function(e){return e.x<180?"start":"end"}).attr("transform",function(e){return e.x<180?"translate(8)":"rotate(180)translate(-8)"}).attr("font-family","Helvetica").attr("font-size","10px").text(function(e){return e.name});d3.select(self.frameElement).style("height",e-150+"px")};app.layouts.vertical=function(){var e=app.config.width,t=app.config.height,n=app.config.noderadius,r=d3.layout.cluster().size([t,e-160]),i=d3.svg.diagonal().projection(function(e){return[e.y,e.x]}),s=d3.select("#canvas").append("svg").attr("id","rendering").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").attr("version","1.1").attr("width",e).attr("height",t).append("g").attr("transform","translate(40,0)"),o=r.nodes(app.nodes),u=r.links(o),a=s.selectAll(".link").data(u).enter().append("path").attr("class","link").attr("fill","none").attr("stroke","#ccc").attr("stroke-width","1.5px").attr("d",i),f=s.selectAll(".node").data(o).enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.y+","+e.x+")"});f.append("circle").attr("fill","#fff").attr("stroke","steelblue").attr("stroke-width","1.5px").attr("r",n);f.append("text").attr("dx",function(e){return e.children?-8:8}).attr("dy",3).attr("font-family","Helvetica").attr("font-size","10px").attr("text-anchor",function(e){return e.children?"end":"start"}).text(function(e){return e.name})};app.convertFreemindNodes=function(e){var t=function(e,n){e._TEXT&&(n.name=e._TEXT);e._LINK&&(n.url=e._LINK);if(e.node&&e.node.length){n.children=[];for(var r=0;r<e.node.length;r++){var i={};i=t(e.node[r],i);n.children.push(i)}}return n},n={};n=t(e.map.node,n);console.log("Converted Tree: ",n);return n};